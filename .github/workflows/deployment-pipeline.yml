name: "MuleSoft CloudHub 2.0 CI/CD - Multi-Repo Deployment"

on:
  repository_dispatch:
    types: [trigger-mule-deploy]

env:
  JAVA_VERSION: 17
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  ENVIRONMENT: Sandbox
  REGION: us-east-1
  DEPLOYMENT_NAME: ${{ github.event.client_payload.app_name }}
  CHILD_REPO: ${{ github.event.client_payload.repo }}
  RELEASE_TAG: "v1.0.${{ github.run_number }}"

jobs:

  # ===========================================================
  # 1️⃣ CHECKOUT CHILD REPOSITORY
  # ===========================================================

  checkout:
    name: "Checkout Child Repository"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Parent Repository
        uses: actions/checkout@v4

      - name: Checkout Triggered Child Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CHILD_REPO }}
          token: ${{ secrets.CHILD_REPO_TOKEN }}
          path: mule-app

      - name: Upload Source as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "mule-source"
          path: mule-app
          retention-days: 2

  # ===========================================================
  # 2️⃣ RUN MUNIT TESTS
  # ===========================================================

  test:
    name: "Run MUnit Tests"
    runs-on: ubuntu-latest
    needs: checkout

    steps:
      - name: Download Source Artifact
        uses: actions/download-artifact@v4
        with:
          name: "mule-source"
          path: mule-app

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: munit-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Run MUnit Tests
        run: |
          cd mule-app
          mvn clean test -D"mule.env"="${{ env.ENVIRONMENT }}" -D"mule.key"="${{ secrets.MULE_KEY }}"

      - name: Upload MUnit Report
        uses: actions/upload-artifact@v4
        with:
          name: "munit-report"
          path: mule-app/target/site/munit/coverage
          retention-days: 2

  # ===========================================================
  # 3️⃣ BUILD APPLICATION
  # ===========================================================

  build:
    name: "Build Mule Application"
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Download Source Artifact
        uses: actions/download-artifact@v4
        with:
          name: "mule-source"
          path: mule-app

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Package Mule Application
        run: |
          cd mule-app
          mvn -B clean package -DskipTests

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "mule-artifact"
          path: mule-app/target/*.jar
          retention-days: 2

  # ===========================================================
  # 4️⃣ PUBLISH TO ANYPOINT EXCHANGE
  # ===========================================================

  publish:
    name: "Publish Artifact to Anypoint Exchange"
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: "mule-artifact"
          path: target

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: publish-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Publish Artifact to Exchange
        env:
          CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          cd mule-app
          mvn clean deploy \
            -DskipTests \
            -Dclient.id=$CLIENT_ID \
            -Dclient.secret=$CLIENT_SECRET \
            -Drelease.version=${{ env.RELEASE_TAG }} \
            -s settings.xml

  # ===========================================================
  # 5️⃣ DEPLOY TO CLOUDHUB 2.0
  # ===========================================================

  deploy:
    name: "Deploy to CloudHub 2.0"
    runs-on: ubuntu-latest
    needs: publish
    environment:
      name: DEV
      url: https://anypoint.mulesoft.com

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: "mule-artifact"
          path: build

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: deploy-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Deploy to CloudHub 2.0
        env:
          CLIENT_ID: ${{ secrets.ANYPOINT_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ANYPOINT_CLIENT_SECRET }}
        run: |
          cd mule-app
          mvn clean deploy -DmuleDeploy \
            -Danypoint.platform.client_id=$CLIENT_ID \
            -Danypoint.platform.client_secret=$CLIENT_SECRET \
            -Denv=${{ env.ENVIRONMENT }} \
            -Dregion=${{ env.REGION }} \
            -Dapplication.name=${{ env.DEPLOYMENT_NAME }}

  # ===========================================================
  # 6️⃣ EMAIL NOTIFICATION
  # ===========================================================

  notify:
    name: "Send Deployment Status Email"
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "MuleSoft CI/CD Deployment - ${{ job.status }} (${{ env.DEPLOYMENT_NAME }})"
          to: "csai22040@glbitm.ac.in"
          from: "Mule CI/CD <${{ secrets.MAIL_USERNAME }}>"
          body: |
            Hello Team,

            ✅ **MuleSoft CloudHub 2.0 Deployment Summary**

            ▪ Application: ${{ env.DEPLOYMENT_NAME }}  
            ▪ Repository: ${{ env.CHILD_REPO }}  
            ▪ Environment: ${{ env.ENVIRONMENT }}  
            ▪ Version: ${{ env.RELEASE_TAG }}  
            ▪ Status: ${{ job.status }}  
            ▪ Triggered by: ${{ github.actor }}

            View Workflow Logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Regards,  
            MuleSoft CI/CD Automation
